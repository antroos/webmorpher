import sys
import os
import json
import asyncio
import socket
import subprocess
import time
from functools import partial

# Add environment variables to prevent OpenBLAS threading issues
os.environ["OPENBLAS_NUM_THREADS"] = "1"
os.environ["MKL_NUM_THREADS"] = "1"
os.environ["VECLIB_MAXIMUM_THREADS"] = "1"
os.environ["NUMEXPR_NUM_THREADS"] = "1"
os.environ["OMP_NUM_THREADS"] = "1"

from PyQt5.QtWidgets import (QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout, 
                            QPushButton, QTextEdit, QLabel, QLineEdit, QMessageBox, QDialog,
                            QListWidget, QTabWidget, QSplitter, QFrame, QFileDialog, QCheckBox,
                            QStyleFactory, QGroupBox, QToolButton)
from PyQt5.QtCore import Qt, QSize, QThread, pyqtSignal, QObject, QRect, QPoint, QPropertyAnimation
from PyQt5.QtGui import QFont, QPalette, QColor, QFontDatabase, QIcon
from browser_use import Agent, Browser, BrowserConfig
from langchain_openai import ChatOpenAI
from tempfile import gettempdir
import resources_rc  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª —Ä–µ—Å—É—Ä—Å–æ–≤

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
if getattr(sys, 'frozen', False):
    # –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –∏–∑ .app –±–∞–Ω–¥–ª–∞
    APP_ROOT = os.path.dirname(os.path.dirname(os.path.dirname(sys.executable)))
    RESOURCES_ROOT = os.path.join(APP_ROOT, 'Resources')
else:
    # –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞
    APP_ROOT = os.path.dirname(os.path.abspath(__file__))
    RESOURCES_ROOT = APP_ROOT

# –®–ª—è—Ö –¥–æ —Ñ–∞–π–ª—É –∑ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º–∏
CONFIG_FILE = os.path.expanduser("~/.webmorpher_config.json")
# –®–ª—è—Ö –¥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó –ø—Ä–æ—Ñ—ñ–ª—é –±—Ä–∞—É–∑–µ—Ä–∞
BROWSER_PROFILE_DIR = os.path.expanduser("~/.webmorpher_browser_profile")

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è —à–ª—è—Ö—É –¥–æ —ñ–∫–æ–Ω–æ–∫
def get_icon_path(icon_name):
    """–í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —à–ª—è—Ö—É –¥–æ —ñ–∫–æ–Ω–∫–∏ –≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ —Ä–µ–∂–∏–º—É –∑–∞–ø—É—Å–∫—É"""
    # –í —Ä–µ–∂–∏–º—ñ —Ä–æ–∑—Ä–æ–±–∫–∏ —ñ–∫–æ–Ω–∫–∏ –∑–Ω–∞—Ö–æ–¥—è—Ç—å—Å—è –≤ –ø–∞–ø—Ü—ñ icons/svg
    dev_path = os.path.join(RESOURCES_ROOT, 'icons', 'svg', icon_name)
    
    # –í —Ä–µ–∂–∏–º—ñ –¥–æ–¥–∞—Ç–∫–∞ —ñ–∫–æ–Ω–∫–∏ –∑–Ω–∞—Ö–æ–¥—è—Ç—å—Å—è –≤ Resources/icons/svg
    app_path = os.path.join(RESOURCES_ROOT, 'icons', 'svg', icon_name)
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —è–∫–∏–π —à–ª—è—Ö —ñ—Å–Ω—É—î
    if os.path.exists(dev_path):
        return dev_path
    elif os.path.exists(app_path):
        return app_path
    else:
        print(f"–ü–û–ü–ï–†–ï–î–ñ–ï–ù–ù–Ø: –Ü–∫–æ–Ω–∫–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞: {icon_name}")
        # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —ñ–∫–æ–Ω–∫–∏ –∑ —Ä–µ—Å—É—Ä—Å—ñ–≤
        return f":/icons/svg/{icon_name}"

def get_default_chrome_profile():
    """–í–∏–∑–Ω–∞—á–µ–Ω–Ω—è —à–ª—è—Ö—É –¥–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ Chrome/Chromium"""
    user_profile_dir = None
    
    if sys.platform == 'darwin':  # macOS
        # –®–ª—è—Ö –¥–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é Chrome –Ω–∞ macOS
        chrome_profile_alt = os.path.expanduser("~/Library/Application Support/Google/Chrome")
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –∫–∞—Ç–∞–ª–æ–≥—É
        if os.path.exists(chrome_profile_alt) and os.path.isdir(chrome_profile_alt):
            user_profile_dir = chrome_profile_alt
    elif sys.platform.startswith('win'):  # Windows
        # –®–ª—è—Ö –¥–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é Chrome –Ω–∞ Windows
        chrome_profile = os.path.join(os.environ.get('LOCALAPPDATA', ''), 
                                     "Google", "Chrome", "User Data")
        if os.path.exists(chrome_profile) and os.path.isdir(chrome_profile):
            user_profile_dir = chrome_profile
    elif sys.platform.startswith('linux'):  # Linux
        # –®–ª—è—Ö –¥–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é Chrome –Ω–∞ Linux
        chrome_profile = os.path.expanduser("~/.config/google-chrome")
        if os.path.exists(chrome_profile) and os.path.isdir(chrome_profile):
            user_profile_dir = chrome_profile
    
    return user_profile_dir

class BrowserUseRunner(QThread):
    """–ö–ª–∞—Å –¥–ª—è –∑–∞–ø—É—Å–∫—É browser-use —É –æ–∫—Ä–µ–º–æ–º—É –ø–æ—Ç–æ—Ü—ñ"""
    log_signal = pyqtSignal(str)
    finished_signal = pyqtSignal()
    error_signal = pyqtSignal(str)
    
    def __init__(self, api_key, task, headless=False, debug_port=None, user_profile_dir=None):
        super().__init__()
        self.api_key = api_key
        self.task = task
        self.headless = headless
        self.debug_port = debug_port
        self.user_profile_dir = user_profile_dir
        self._is_paused = False
        self._is_stopped = False
        self.agent = None
    
    def run(self):
        """–ó–∞–ø—É—Å–∫ browser-use –∞–≥–µ–Ω—Ç–∞"""
        try:
            os.environ["OPENAI_API_KEY"] = self.api_key
            
            # –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è ChatOpenAI –º–æ–¥–µ–ª—ñ
            llm = ChatOpenAI(model="gpt-4o")
            
            # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –±—Ä–∞—É–∑–µ—Ä–∞ –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
            if self.debug_port:
                # –î–ª—è —Ä–µ–∂–∏–º—É –¥–µ–±–∞–≥—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ cdp_url
                browser_config = BrowserConfig(cdp_url=f"http://localhost:{self.debug_port}")
            else:
                # –®–ª—è—Ö –¥–æ Google Chrome –Ω–∞ macOS
                chrome_paths = [
                    "/Applications/Google Chrome.app/Contents/MacOS/Google Chrome",  # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—É—Ç—å
                    os.path.expanduser("~/Applications/Google Chrome.app/Contents/MacOS/Google Chrome"),  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                    "/Applications/Chromium.app/Contents/MacOS/Chromium",  # Chromium –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
                ]
                
                # –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—ã–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –±—Ä–∞—É–∑–µ—Ä
                chrome_path = None
                for path in chrome_paths:
                    if os.path.exists(path):
                        chrome_path = path
                        break
                
                if not chrome_path:
                    raise Exception("–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ Google Chrome –∞–±–æ Chromium. –ë—É–¥—å –ª–∞—Å–∫–∞, –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –æ–¥–∏–Ω –∑ –±—Ä–∞—É–∑–µ—Ä—ñ–≤.")
                
                # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±—Ä–∞—É–∑–µ—Ä–∞
                browser_config_params = {
                    'headless': self.headless,
                    'browser_binary_path': chrome_path,
                }
                
                # –ï—Å–ª–∏ –∑–∞–¥–∞–Ω –∫–∞—Ç–∞–ª–æ–≥ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                if self.user_profile_dir:
                    browser_config_params['user_data_dir'] = self.user_profile_dir
                
                # –î–ª—è –∑–≤–∏—á–∞–π–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ browser_binary_path –∏ user_data_dir
                browser_config = BrowserConfig(**browser_config_params)
                
            browser = Browser(config=browser_config)
            
            # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞–≥–µ–Ω—Ç–∞ –∑ callback –¥–ª—è –ª–æ–≥—É–≤–∞–Ω–Ω—è
            self.agent = Agent(
                task=self.task,
                llm=llm,
                browser=browser,
                register_new_step_callback=self._on_new_step
            )
            
            # –ó–∞–ø—É—Å–∫–∞—î–º–æ –∞–≥–µ–Ω—Ç–∞ –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            
            if not self._is_stopped:
                self.log_signal.emit("–ó–∞–ø—É—Å–∫ –±—Ä–∞—É–∑–µ—Ä–∞ —Ç–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∞–≥–µ–Ω—Ç–∞...")
                result = loop.run_until_complete(self._run_with_pause_check())
                self.log_signal.emit("–í–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")
                self.finished_signal.emit()
        
        except Exception as e:
            error_msg = f"–ü–æ–º–∏–ª–∫–∞: {str(e)}"
            
            # Check if it might be an OpenBLAS threading issue
            if "EXC_BAD_ACCESS" in str(e) or "segmentation fault" in str(e).lower():
                error_msg += "\n\n–ú–æ–∂–ª–∏–≤–æ, —Ü–µ –ø–æ–≤'—è–∑–∞–Ω–æ –∑ –ø—Ä–æ–±–ª–µ–º–æ—é –±–∞–≥–∞—Ç–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—ñ –≤ NumPy/OpenBLAS."
                error_msg += "\n–°–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ –ø—Ä–æ–≥—Ä–∞–º—É —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ñ–æ–Ω–æ–≤–∏–π —Ä–µ–∂–∏–º –±—Ä–∞—É–∑–µ—Ä–∞."
            
            self.error_signal.emit(error_msg)
    
    async def _run_with_pause_check(self):
        """–ó–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–∞ –∑ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—é –ø–∞—É–∑–∏"""
        try:
            # –ó–∞–ø—É—Å–∫–∞—î–º–æ –∞–≥–µ–Ω—Ç–∞
            result = await self.agent.run()
            return result
        except Exception as e:
            self.error_signal.emit(f"–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è: {str(e)}")
            return None
    
    async def _on_new_step(self, state, output, step_index):
        """–ö–æ–ª–±–µ–∫ –¥–ª—è –ª–æ–≥—É–≤–∞–Ω–Ω—è –∫—Ä–æ–∫—ñ–≤ –∞–≥–µ–Ω—Ç–∞"""
        # –î–æ–¥–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –∑ AgentBrain
        if hasattr(output, 'current_state'):
            brain = output.current_state
            if brain.next_goal:
                self.log_signal.emit(f"üéØ –ù–∞—Å—Ç—É–ø–Ω–∞ —Ü—ñ–ª—å: {brain.next_goal}")
            if brain.evaluation_previous_goal:
                self.log_signal.emit(f"‚úì –†–µ–∑—É–ª—å—Ç–∞—Ç: {brain.evaluation_previous_goal}")
        
        # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ —Å—Ç–∞—Ç—É—Å–∏
        action_type = getattr(output, 'action_type', None)
        content = getattr(output, 'content', None)
        
        if action_type == "thinking":
            self.log_signal.emit(f"ü§î –ú–æ–¥–µ–ª—å –¥—É–º–∞—î: {content}")
        elif action_type == "browser_action":
            self.log_signal.emit(f"üåê –ë—Ä–∞—É–∑–µ—Ä: {content}")
        elif action_type == "agent_action":
            self.log_signal.emit(f"ü§ñ –ê–≥–µ–Ω—Ç: {content}")
        elif action_type == "error":
            self.log_signal.emit(f"‚ùå –ü–æ–º–∏–ª–∫–∞: {content}")
        elif content:
            self.log_signal.emit(f"{action_type}: {content}")
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –ø–∞—É–∑–∞
        while self._is_paused and not self._is_stopped:
            await asyncio.sleep(0.1)  # –ú–∞–ª–µ–Ω—å–∫–∞ –∑–∞—Ç—Ä–∏–º–∫–∞, —â–æ–± –Ω–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ –ø—Ä–æ—Ü–µ—Å–æ—Ä
        
        # –Ø–∫—â–æ –∑—É–ø–∏–Ω–µ–Ω–æ, –ø—ñ–¥–Ω—ñ–º–∞—î–º–æ –≤–∏–∫–ª—é—á–µ–Ω–Ω—è –¥–ª—è –∑—É–ø–∏–Ω–∫–∏ –∞–≥–µ–Ω—Ç–∞
        if self._is_stopped:
            raise Exception("–í–∏–∫–æ–Ω–∞–Ω–Ω—è –∑—É–ø–∏–Ω–µ–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º")
    
    def pause(self):
        """–ü—Ä–∏–∑—É–ø–∏–Ω–µ–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è"""
        self._is_paused = True
        self.log_signal.emit("‚è∏Ô∏è –í–∏–∫–æ–Ω–∞–Ω–Ω—è –ø—Ä–∏–∑—É–ø–∏–Ω–µ–Ω–æ...")
    
    def resume(self):
        """–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è"""
        self._is_paused = False
        self.log_signal.emit("‚ñ∂Ô∏è –í–∏–∫–æ–Ω–∞–Ω–Ω—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ...")
    
    def stop(self):
        """–ó—É–ø–∏–Ω–∫–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è"""
        self._is_stopped = True
        self._is_paused = False
        self.log_signal.emit("‚èπÔ∏è –í–∏–∫–æ–Ω–∞–Ω–Ω—è –∑—É–ø–∏–Ω–µ–Ω–æ!")

def find_free_port():
    """–ó–Ω–∞–π—Ç–∏ –≤—ñ–ª—å–Ω–∏–π –ø–æ—Ä—Ç –¥–ª—è –∑–∞–ø—É—Å–∫—É –¥–µ–±–∞–≥-—Å–µ—Ä–≤–µ—Ä–∞"""
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        s.bind(('', 0))
        return s.getsockname()[1]

def launch_debug_browser(port=9222, use_user_profile=True, user_profile_dir=None):
    """–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –±—Ä–∞—É–∑–µ—Ä —É —Ä–µ–∂–∏–º—ñ –¥–µ–±–∞–≥—É –Ω–∞ –≤–∫–∞–∑–∞–Ω–æ–º—É –ø–æ—Ä—Ç—ñ"""
    # –®–ª—è—Ö –¥–æ Chrome –Ω–∞ macOS
    if sys.platform == 'darwin':  # macOS
        chrome_paths = [
            "/Applications/Google Chrome.app/Contents/MacOS/Google Chrome",  # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—É—Ç—å
            os.path.expanduser("~/Applications/Google Chrome.app/Contents/MacOS/Google Chrome"),  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            "/Applications/Chromium.app/Contents/MacOS/Chromium",  # Chromium –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
        ]
        
        # –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—ã–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –±—Ä–∞—É–∑–µ—Ä
        chrome_path = None
        for path in chrome_paths:
            if os.path.exists(path):
                chrome_path = path
                break
                
        if not chrome_path:
            raise Exception("–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ Google Chrome –∞–±–æ Chromium. –ë—É–¥—å –ª–∞—Å–∫–∞, –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –æ–¥–∏–Ω –∑ –±—Ä–∞—É–∑–µ—Ä—ñ–≤.")
            
        print(f"–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –±—Ä–∞—É–∑–µ—Ä –∑–∞ —à–ª—è—Ö–æ–º: {chrome_path}")
    else:
        # –î–ª—è Linux —Ç–∞ —ñ–Ω—à–∏—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º
        chrome_path = "google-chrome"
    
    # –í–∏–∑–Ω–∞—á–∞—î–º–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é –¥–ª—è –ø—Ä–æ—Ñ—ñ–ª—é Chrome
    if use_user_profile and user_profile_dir:
        # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        debug_profile_dir = user_profile_dir
        print(f"–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–ª—è –¥–µ–±–∞–≥—É: {debug_profile_dir}")
    else:
        # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ç–∏–º—á–∞—Å–æ–≤—É –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é –¥–ª—è –ø—Ä–æ—Ñ—ñ–ª—é Chrome
        debug_profile_dir = os.path.join(gettempdir(), f"chrome-debug-{port}")
        os.makedirs(debug_profile_dir, exist_ok=True)
    
    cmd = [
        chrome_path,
        f"--remote-debugging-port={port}",
        "--no-first-run",
        "--no-default-browser-check",
        f"--user-data-dir={debug_profile_dir}",
        "--disable-application-cache",  # –í—ñ–¥–∫–ª—é—á–∞—î–º–æ –∫–µ—à –¥–ª—è –∑–º–µ–Ω—à–µ–Ω–Ω—è –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤
        "about:blank"
    ]
    
    print(f"–ó–∞–ø—É—Å–∫–∞—î–º–æ –∫–æ–º–∞–Ω–¥—É: {' '.join(cmd)}")
    
    try:
        process = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        print(f"–ë—Ä–∞—É–∑–µ—Ä –∑–∞–ø—É—â–µ–Ω–æ –∑ PID: {process.pid}")
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ –±—Ä–∞—É–∑–µ—Ä —Å–ø—Ä–∞–≤–¥—ñ –ø—Ä–∞—Ü—é—î
        time.sleep(2)  # –ß–µ–∫–∞—î–º–æ, —â–æ–± –±—Ä–∞—É–∑–µ—Ä –≤—Å—Ç–∏–≥ –∑–∞–ø—É—Å—Ç–∏—Ç–∏—Å—è
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ –ø—Ä–æ—Ü–µ—Å –¥–æ—Å—ñ –∞–∫—Ç–∏–≤–Ω–∏–π
        if process.poll() is not None:
            error = process.stderr.read().decode('utf-8', errors='ignore')
            raise Exception(f"–ë—Ä–∞—É–∑–µ—Ä –∑–∞–≤–µ—Ä—à–∏–≤—Å—è –∑ –∫–æ–¥–æ–º {process.returncode}. –ü–æ–º–∏–ª–∫–∞: {error}")
            
        return process, port
    except Exception as e:
        raise Exception(f"–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –±—Ä–∞—É–∑–µ—Ä: {str(e)}")

class ApiKeyDialog(QDialog):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("–í–≤–µ–¥—ñ—Ç—å API –∫–ª—é—á")
        self.setFixedSize(400, 150)
        self.api_key = ""
        
        layout = QVBoxLayout()
        
        # –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        info_label = QLabel("–î–ª—è —Ä–æ–±–æ—Ç–∏ –ø—Ä–æ–≥—Ä–∞–º–∏ –ø–æ—Ç—Ä—ñ–±–µ–Ω API –∫–ª—é—á OpenAI.\n–í–≤–µ–¥—ñ—Ç—å –≤–∞—à –∫–ª—é—á –¥–ª—è –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è:")
        layout.addWidget(info_label)
        
        # –ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥—É –∫–ª—é—á–∞
        self.key_input = QLineEdit()
        self.key_input.setPlaceholderText("sk-...")
        layout.addWidget(self.key_input)
        
        # –ö–Ω–æ–ø–∫–∏
        button_layout = QHBoxLayout()
        
        self.save_button = QPushButton("–ó–±–µ—Ä–µ–≥—Ç–∏")
        self.save_button.clicked.connect(self.accept_key)
        
        self.cancel_button = QPushButton("–°–∫–∞—Å—É–≤–∞—Ç–∏")
        self.cancel_button.clicked.connect(self.reject)
        
        button_layout.addWidget(self.save_button)
        button_layout.addWidget(self.cancel_button)
        
        layout.addLayout(button_layout)
        self.setLayout(layout)
    
    def accept_key(self):
        api_key = self.key_input.text().strip()
        if not api_key or not api_key.startswith("sk-"):
            QMessageBox.warning(self, "–ü–æ–º–∏–ª–∫–∞", "–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π API –∫–ª—é—á, —â–æ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ 'sk-'")
            return
        
        self.api_key = api_key
        self.accept()

class ProgramEditorDialog(QDialog):
    def __init__(self, program_name="", program_code="", parent=None):
        super().__init__(parent)
        self.setWindowTitle("–†–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–æ–≥—Ä–∞–º–∏")
        self.setMinimumSize(600, 400)
        
        self.layout = QVBoxLayout()
        
        # –ù–∞–∑–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–∏
        name_layout = QHBoxLayout()
        name_label = QLabel("–ù–∞–∑–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–∏:")
        self.name_input = QLineEdit(program_name)
        name_layout.addWidget(name_label)
        name_layout.addWidget(self.name_input)
        self.layout.addLayout(name_layout)
        
        # –†–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–¥—É
        code_label = QLabel("–ö–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–∏:")
        self.code_editor = QTextEdit()
        self.code_editor.setPlainText(program_code)
        self.layout.addWidget(code_label)
        self.layout.addWidget(self.code_editor)
        
        # –ö–Ω–æ–ø–∫–∏
        button_layout = QHBoxLayout()
        self.save_button = QPushButton("–ó–±–µ—Ä–µ–≥—Ç–∏")
        self.save_button.clicked.connect(self.accept)
        
        self.cancel_button = QPushButton("–°–∫–∞—Å—É–≤–∞—Ç–∏")
        self.cancel_button.clicked.connect(self.reject)
        
        button_layout.addWidget(self.save_button)
        button_layout.addWidget(self.cancel_button)
        
        self.layout.addLayout(button_layout)
        self.setLayout(self.layout)
    
    def get_program_data(self):
        return {
            "name": self.name_input.text().strip(),
            "code": self.code_editor.toPlainText().strip()
        }

class WebMorpherApp(QMainWindow):
    def __init__(self):
        super().__init__()
        
        # –û—Å–Ω–æ–≤–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤—ñ–∫–Ω–∞
        self.setWindowTitle("WebMorpher")
        self.setGeometry(100, 100, 1200, 800)
        self.setMinimumSize(1000, 700)
        
        # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∏–ª—å –≤—ñ–∫–Ω–∞ –¥–ª—è macOS
        if sys.platform == 'darwin':
            self.setWindowFlags(Qt.Window | Qt.WindowFullscreenButtonHint | Qt.WindowTitleHint | 
                               Qt.WindowCloseButtonHint | Qt.WindowMinimizeButtonHint)
            # –ê–∫—Ç–∏–≤—É—î–º–æ –ø—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å –≤—ñ–∫–Ω–∞
            self.setAttribute(Qt.WA_TranslucentBackground)
        
        # –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∑–º—ñ–Ω–Ω–∏—Ö
        self.programs = []
        self.current_program = None
        self.program_running = False
        self.browser_runner = None
        self.is_paused = False
        
        # –í–∏–∑–Ω–∞—á–∞—î–º–æ —à–ª—è—Ö –¥–æ –ø—Ä–æ—Ñ—ñ–ª—é Chrome
        self.chrome_profile_path = get_default_chrome_profile()
        
        # –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–µ–º–∏
        self.dark_mode = False  # –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º —Å–≤—ñ—Ç–ª–∞ —Ç–µ–º–∞
        self.update_theme()
        
        # –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
        self.api_key = ""
        self.load_config()
        
        # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ API –∫–ª—é—á–∞
        if not self.check_api_key():
            self.show()  # –ü–æ–∫–∞–∑—É—î–º–æ –≤—ñ–∫–Ω–æ –ø–µ—Ä–µ–¥ –¥—ñ–∞–ª–æ–≥–æ–º, —â–æ–± –≤–æ–Ω–æ –±—É–ª–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–æ–≤–∞–Ω–æ
        
        # –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        self.setup_ui()
        
        # –ü–æ–∫–∞–∑—É—î–º–æ –≤—ñ–∫–Ω–æ
        self.show()
        
    def update_theme(self):
        """–û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–µ–º–∏ –¥–æ–¥–∞—Ç–∫—É (—Å–≤—ñ—Ç–ª–∞/—Ç–µ–º–Ω–∞)"""
        if self.dark_mode:
            # –¢–µ–º–Ω–∞ —Ç–µ–º–∞
            self.setStyleSheet("""
                QMainWindow {
                    background-color: rgba(40, 40, 40, 0.85);
                    border-radius: 10px;
                }
                #mainContainer {
                    background-color: rgba(50, 50, 50, 0.95);
                    border-radius: 15px;
                    border: 1px solid rgba(70, 70, 70, 0.3);
                }
                #topPanel {
                    background-color: rgba(45, 45, 45, 0.95);
                    border-bottom: 1px solid rgba(70, 70, 70, 0.3);
                }
                QToolButton {
                    color: #0A84FF;
                }
                QToolButton:hover {
                    background-color: rgba(10, 132, 255, 0.1);
                }
                QToolButton:pressed {
                    background-color: rgba(10, 132, 255, 0.2);
                }
                QToolButton:disabled {
                    color: rgba(10, 132, 255, 0.5);
                }
                #sidebar {
                    background-color: rgba(45, 45, 45, 0.8);
                    border-right: 1px solid rgba(70, 70, 70, 0.3);
                }
                QLabel {
                    color: #FFFFFF;
                }
                QListWidget {
                    background-color: rgba(60, 60, 60, 0.5);
                    border: 1px solid rgba(80, 80, 80, 0.3);
                    color: #FFFFFF;
                }
                QListWidget::item:hover {
                    background-color: rgba(10, 132, 255, 0.1);
                }
                QListWidget::item:selected {
                    background-color: rgba(10, 132, 255, 0.2);
                    color: #0A84FF;
                }
                QGroupBox {
                    border: 1px solid rgba(80, 80, 80, 0.3);
                    background-color: rgba(60, 60, 60, 0.5);
                    color: #FFFFFF;
                }
                QCheckBox {
                    color: #FFFFFF;
                }
                QTabBar::tab {
                    background-color: rgba(60, 60, 60, 0.7);
                    color: #FFFFFF;
                }
                QTabBar::tab:selected {
                    background-color: rgba(10, 132, 255, 0.8);
                    color: white;
                }
                QTextEdit {
                    background-color: rgba(60, 60, 60, 0.7);
                    color: #FFFFFF;
                    border: 1px solid rgba(80, 80, 80, 0.3);
                }
                QStatusBar {
                    background-color: rgba(45, 45, 45, 0.9);
                    color: #FFFFFF;
                    border-top: 1px solid rgba(70, 70, 70, 0.3);
                }
            """)
        else:
            # –°–≤—ñ—Ç–ª–∞ —Ç–µ–º–∞
            self.setStyleSheet("""
                QMainWindow {
                    background-color: rgba(240, 240, 240, 0.85);
                    border-radius: 10px;
                }
            """)
            # –†–µ—à—Ç–∞ —Å—Ç–∏–ª—ñ–≤ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—é—Ç—å—Å—è –≤ setup_ui
        
    def load_config(self):
        """–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –∑ —Ñ–∞–π–ª—É"""
        if os.path.exists(CONFIG_FILE):
            try:
                with open(CONFIG_FILE, 'r') as f:
                    config = json.load(f)
                    self.api_key = config.get('api_key', '')
                    self.programs = config.get('programs', [])
            except Exception as e:
                print(f"–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó: {e}")
    
    def save_config(self):
        """–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó —É —Ñ–∞–π–ª"""
        config = {
            'api_key': self.api_key,
            'programs': self.programs
        }
        try:
            with open(CONFIG_FILE, 'w') as f:
                json.dump(config, f)
        except Exception as e:
            print(f"–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó: {e}")
    
    def check_api_key(self):
        """–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ API –∫–ª—é—á–∞"""
        if not self.api_key:
            dialog = ApiKeyDialog(self)
            # –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø—É—Å—Ç–æ–µ
            dialog.key_input.setText("")  
            if dialog.exec_():
                self.api_key = dialog.api_key
                self.save_config()
                return True
            else:
                return False
        return True
            
    def setup_ui(self):
        """–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞"""
        central_widget = QWidget()
        self.setCentralWidget(central_widget)
        
        # –û—Å–Ω–æ–≤–Ω–∏–π –º–∞–∫–µ—Ç –∑ –≤–µ—Ä—Ö–Ω—å–æ—é –ø–∞–Ω–µ–ª–ª—é —Ç–∞ –≥–æ–ª–æ–≤–Ω–∏–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
        main_layout = QVBoxLayout(central_widget)
        main_layout.setContentsMargins(10, 10, 10, 10)  # –í—ñ–¥—Å—Ç—É–ø–∏ –¥–ª—è —Ç—ñ–Ω—ñ —Ç–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è
        main_layout.setSpacing(0)  # –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –≤—ñ–¥—Å—Ç—É–ø–∏ –º—ñ–∂ –µ–ª–µ–º–µ–Ω—Ç–∞–º–∏
        
        # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑ —Ç—ñ–Ω–Ω—é —Ç–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–º–∏ –∫—É—Ç–∞–º–∏
        main_container = QFrame()
        main_container.setObjectName("mainContainer")
        main_container.setStyleSheet("""
            #mainContainer {
                background-color: rgba(255, 255, 255, 0.95);
                border-radius: 15px;
                border: 1px solid rgba(0, 0, 0, 0.1);
            }
        """)
        container_layout = QVBoxLayout(main_container)
        container_layout.setContentsMargins(0, 0, 0, 0)
        container_layout.setSpacing(0)
        
        # 1. –í–ï–†–•–ù–Ø –ü–ê–ù–ï–õ–¨ (Toolbar)
        top_panel = QFrame()
        top_panel.setObjectName("topPanel")
        top_panel.setStyleSheet("""
            #topPanel {
                background-color: rgba(248, 248, 248, 0.95);
                border-top-left-radius: 15px;
                border-top-right-radius: 15px;
                border-bottom: 1px solid rgba(0, 0, 0, 0.1);
                min-height: 70px;
                padding: 10px;
            }
        """)
        top_layout = QHBoxLayout(top_panel)
        top_layout.setContentsMargins(15, 5, 15, 5)
        
        # –ö–Ω–æ–ø–∫–∏ —É –≤–µ—Ä—Ö–Ω—ñ–π –ø–∞–Ω–µ–ª—ñ (—Ç–µ–ø–µ—Ä –∑ —ñ–∫–æ–Ω–∫–∞–º–∏)
        # 1. –ö–Ω–æ–ø–∫–∞ "–ù–æ–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–∞"
        self.new_button = QToolButton()
        self.new_button.setIcon(QIcon(get_icon_path("add.svg")))
        self.new_button.setText("–ù–æ–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–∞")
        self.new_button.setToolButtonStyle(Qt.ToolButtonTextUnderIcon)
        self.new_button.setIconSize(QSize(32, 32))
        self.new_button.setMinimumWidth(80)
        self.new_button.clicked.connect(self.create_program)
        self.new_button.setStyleSheet("""
            QToolButton {
                border: none;
                color: #007AFF;
                padding: 6px;
                border-radius: 6px;
            }
            QToolButton:hover {
                background-color: rgba(0, 122, 255, 0.1);
            }
            QToolButton:pressed {
                background-color: rgba(0, 122, 255, 0.2);
            }
        """)
        
        # 2. –ö–Ω–æ–ø–∫–∞ "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏"
        self.edit_button = QToolButton()
        self.edit_button.setIcon(QIcon(get_icon_path("edit.svg")))
        self.edit_button.setText("–†–µ–¥–∞–≥—É–≤–∞—Ç–∏")
        self.edit_button.setToolButtonStyle(Qt.ToolButtonTextUnderIcon)
        self.edit_button.setIconSize(QSize(32, 32))
        self.edit_button.setMinimumWidth(80)
        self.edit_button.clicked.connect(self.edit_program)
        self.edit_button.setStyleSheet("""
            QToolButton {
                border: none;
                color: #007AFF;
                padding: 6px;
                border-radius: 6px;
            }
            QToolButton:hover {
                background-color: rgba(0, 122, 255, 0.1);
            }
            QToolButton:pressed {
                background-color: rgba(0, 122, 255, 0.2);
            }
        """)
        
        # 3. –ö–Ω–æ–ø–∫–∞ "–í–∏–¥–∞–ª–∏—Ç–∏"
        self.delete_button = QToolButton()
        self.delete_button.setIcon(QIcon(get_icon_path("delete.svg")))
        self.delete_button.setText("–í–∏–¥–∞–ª–∏—Ç–∏")
        self.delete_button.setToolButtonStyle(Qt.ToolButtonTextUnderIcon)
        self.delete_button.setIconSize(QSize(32, 32))
        self.delete_button.setMinimumWidth(80)
        self.delete_button.clicked.connect(self.delete_program)
        self.delete_button.setStyleSheet("""
            QToolButton {
                border: none;
                color: #007AFF;
                padding: 6px;
                border-radius: 6px;
            }
            QToolButton:hover {
                background-color: rgba(0, 122, 255, 0.1);
            }
            QToolButton:pressed {
                background-color: rgba(0, 122, 255, 0.2);
            }
        """)
        
        # 4. –ö–Ω–æ–ø–∫–∞ "–ó–∞–ø—É—Å—Ç–∏—Ç–∏"
        self.run_button = QToolButton()
        self.run_button.setIcon(QIcon(get_icon_path("play.svg")))
        self.run_button.setText("–ó–∞–ø—É—Å—Ç–∏—Ç–∏")
        self.run_button.setToolButtonStyle(Qt.ToolButtonTextUnderIcon)
        self.run_button.setIconSize(QSize(32, 32))
        self.run_button.setMinimumWidth(80)
        self.run_button.clicked.connect(self.run_program)
        self.run_button.setStyleSheet("""
            QToolButton {
                border: none;
                color: #007AFF;
                padding: 6px;
                border-radius: 6px;
            }
            QToolButton:hover {
                background-color: rgba(0, 122, 255, 0.1);
            }
            QToolButton:pressed {
                background-color: rgba(0, 122, 255, 0.2);
            }
        """)
        
        # 5. –ö–Ω–æ–ø–∫–∞ "–ü–∞—É–∑–∞"
        self.pause_button = QToolButton()
        self.pause_button.setIcon(QIcon(get_icon_path("pause.svg")))
        self.pause_button.setText("–ü–∞—É–∑–∞")
        self.pause_button.setToolButtonStyle(Qt.ToolButtonTextUnderIcon)
        self.pause_button.setIconSize(QSize(32, 32))
        self.pause_button.setMinimumWidth(80)
        self.pause_button.clicked.connect(self.pause_program)
        self.pause_button.setEnabled(False)
        self.pause_button.setStyleSheet("""
            QToolButton {
                border: none;
                color: #007AFF;
                padding: 6px;
                border-radius: 6px;
            }
            QToolButton:hover {
                background-color: rgba(0, 122, 255, 0.1);
            }
            QToolButton:pressed {
                background-color: rgba(0, 122, 255, 0.2);
            }
            QToolButton:disabled {
                color: rgba(0, 122, 255, 0.5);
            }
        """)
        
        # 6. –ö–Ω–æ–ø–∫–∞ "–ó—É–ø–∏–Ω–∏—Ç–∏"
        self.stop_button = QToolButton()
        self.stop_button.setIcon(QIcon(get_icon_path("stop.svg")))
        self.stop_button.setText("–ó—É–ø–∏–Ω–∏—Ç–∏")
        self.stop_button.setToolButtonStyle(Qt.ToolButtonTextUnderIcon)
        self.stop_button.setIconSize(QSize(32, 32))
        self.stop_button.setMinimumWidth(80)
        self.stop_button.clicked.connect(self.stop_program)
        self.stop_button.setEnabled(False)
        self.stop_button.setStyleSheet("""
            QToolButton {
                border: none;
                color: #007AFF;
                padding: 6px;
                border-radius: 6px;
            }
            QToolButton:hover {
                background-color: rgba(0, 122, 255, 0.1);
            }
            QToolButton:pressed {
                background-color: rgba(0, 122, 255, 0.2);
            }
            QToolButton:disabled {
                color: rgba(0, 122, 255, 0.5);
            }
        """)
        
        # –†–æ–∑–¥—ñ–ª—é–≤–∞–ª—å–Ω–∞ –ª—ñ–Ω—ñ—è
        separator = QFrame()
        separator.setFrameShape(QFrame.VLine)
        separator.setFrameShadow(QFrame.Sunken)
        separator.setStyleSheet("background-color: rgba(0, 0, 0, 0.1); margin: 5px 10px;")
        separator.setFixedWidth(1)
        separator.setFixedHeight(50)
        
        # 7. –ö–Ω–æ–ø–∫–∞ "–ó–º—ñ–Ω–∏—Ç–∏ API –∫–ª—é—á"
        self.api_button = QToolButton()
        self.api_button.setIcon(QIcon(get_icon_path("key.svg")))
        self.api_button.setText("API –∫–ª—é—á")
        self.api_button.setToolButtonStyle(Qt.ToolButtonTextUnderIcon)
        self.api_button.setIconSize(QSize(32, 32))
        self.api_button.setMinimumWidth(80)
        self.api_button.clicked.connect(self.change_api_key)
        self.api_button.setStyleSheet("""
            QToolButton {
                border: none;
                color: #007AFF;
                padding: 6px;
                border-radius: 6px;
            }
            QToolButton:hover {
                background-color: rgba(0, 122, 255, 0.1);
            }
            QToolButton:pressed {
                background-color: rgba(0, 122, 255, 0.2);
            }
        """)
        
        top_layout.addWidget(self.new_button)
        top_layout.addWidget(self.edit_button)
        top_layout.addWidget(self.delete_button)
        top_layout.addSpacing(10)
        top_layout.addWidget(self.run_button)
        top_layout.addWidget(self.pause_button)
        top_layout.addWidget(self.stop_button)
        top_layout.addWidget(separator)
        top_layout.addWidget(self.api_button)
        top_layout.addStretch()  # –ü—É—à—É—î–º–æ –∫–Ω–æ–ø–∫–∏ –≤–ª—ñ–≤–æ
        
        container_layout.addWidget(top_panel)
        
        # 2. –û–°–ù–û–í–ù–ò–ô –ö–û–ù–¢–ï–ù–¢ (–∑ –±—ñ—á–Ω–æ—é –ø–∞–Ω–µ–ª–ª—é —Ç–∞ –æ–±–ª–∞—Å—Ç—é –∫–æ–Ω—Ç–µ–Ω—Ç—É)
        content_container = QWidget()
        content_layout = QHBoxLayout(content_container)
        content_layout.setContentsMargins(0, 0, 0, 0)
        content_layout.setSpacing(0)
        
        # 2.1 –ë–Ü–ß–ù–ê –ü–ê–ù–ï–õ–¨
        sidebar = QFrame()
        sidebar.setObjectName("sidebar")
        sidebar.setStyleSheet("""
            #sidebar {
                background-color: rgba(245, 245, 247, 0.8);
                border-right: 1px solid rgba(0, 0, 0, 0.1);
                min-width: 250px;
                max-width: 350px;
            }
        """)
        sidebar_layout = QVBoxLayout(sidebar)
        sidebar_layout.setContentsMargins(15, 15, 15, 15)
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫ –±—ñ—á–Ω–æ—ó –ø–∞–Ω–µ–ª—ñ
        sidebar_title = QLabel("–î–æ—Å—Ç—É–ø–Ω—ñ –ø—Ä–æ–≥—Ä–∞–º–∏")
        sidebar_title.setStyleSheet("font-weight: bold; font-size: 16px; margin-bottom: 15px; color: #333;")
        sidebar_layout.addWidget(sidebar_title)
        
        # –°–ø–∏—Å–æ–∫ –ø—Ä–æ–≥—Ä–∞–º
        self.program_list = QListWidget()
        self.program_list.setStyleSheet("""
            QListWidget {
                background-color: rgba(250, 250, 250, 0.5);
                border: 1px solid rgba(0, 0, 0, 0.1);
                border-radius: 10px;
                padding: 5px;
                outline: none;
            }
            QListWidget::item {
                border-radius: 6px;
                padding: 10px;
                margin: 2px 0px;
            }
            QListWidget::item:hover {
                background-color: rgba(0, 122, 255, 0.1);
            }
            QListWidget::item:selected {
                background-color: rgba(0, 122, 255, 0.2);
                color: #007AFF;
            }
        """)
        self.program_list.currentRowChanged.connect(self.on_program_selected)
        sidebar_layout.addWidget(self.program_list)
        
        # –û–ø—Ü—ñ—ó
        options_group = QGroupBox("–û–ø—Ü—ñ—ó –∑–∞–ø—É—Å–∫—É")
        options_group.setStyleSheet("""
            QGroupBox {
                border: 1px solid rgba(0, 0, 0, 0.1);
                border-radius: 8px;
                margin-top: 10px;
                padding-top: 15px;
                background-color: rgba(250, 250, 250, 0.5);
                font-weight: bold;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top center;
                padding: 0 5px;
                color: #333;
            }
        """)
        options_layout = QVBoxLayout(options_group)
        
        # –û–ø—Ü—ñ—è —Ñ–æ–Ω–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º—É
        self.headless_checkbox = QCheckBox("–ó–∞–ø—É—Å–∫–∞—Ç–∏ –±—Ä–∞—É–∑–µ—Ä —É —Ñ–æ–Ω–æ–≤–æ–º—É —Ä–µ–∂–∏–º—ñ")
        self.headless_checkbox.setStyleSheet("font-size: 13px;")
        options_layout.addWidget(self.headless_checkbox)
        
        # –û–ø—Ü—ñ—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        self.use_user_profile_checkbox = QCheckBox("–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞")
        self.use_user_profile_checkbox.setToolTip("–ó–∞–ø—É—Å–∫–∞—Ç–∏ –∑ –ø—Ä–æ—Ñ—ñ–ª–µ–º, –¥–µ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –ø–∞—Ä–æ–ª—ñ, —ñ—Å—Ç–æ—Ä—ñ—è —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è")
        self.use_user_profile_checkbox.setStyleSheet("font-size: 13px;")
        if not self.chrome_profile_path:
            self.use_user_profile_checkbox.setEnabled(False)
            self.use_user_profile_checkbox.setToolTip("–ü—Ä–æ—Ñ—ñ–ª—å Chrome –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")
        else:
            # –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –Ω–∞–π–¥–µ–Ω, –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –æ–ø—Ü–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            self.use_user_profile_checkbox.setChecked(True)
        
        options_layout.addWidget(self.use_user_profile_checkbox)
        sidebar_layout.addWidget(options_group)
        
        content_layout.addWidget(sidebar)
        
        # 2.2 –û–°–ù–û–í–ù–ê –û–ë–õ–ê–°–¢–¨ –ö–û–ù–¢–ï–ù–¢–£
        main_content = QFrame()
        main_content.setObjectName("mainContent")
        main_content.setStyleSheet("""
            #mainContent {
                background-color: rgba(255, 255, 255, 0.9);
                border-radius: 0px;
            }
        """)
        main_content_layout = QVBoxLayout(main_content)
        main_content_layout.setContentsMargins(20, 20, 20, 20)
        
        # –í–∫–ª–∞–¥–∫–∏ –∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º —Ç–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
        self.tabs = QTabWidget()
        self.tabs.setStyleSheet("""
            QTabWidget::pane {
                border: none;
                background-color: transparent;
            }
            QTabBar::tab {
                background-color: rgba(240, 240, 240, 0.7);
                padding: 8px 16px;
                margin: 4px 2px 0px 2px;
                border-top-left-radius: 6px;
                border-top-right-radius: 6px;
            }
            QTabBar::tab:selected {
                background-color: rgba(0, 122, 255, 0.8);
                color: white;
            }
        """)
        
        # –í–∫–ª–∞–¥–∫–∞ –ø–µ—Ä–µ–≥–ª—è–¥—É –ø—Ä–æ–≥—Ä–∞–º–∏
        self.view_tab = QWidget()
        view_layout = QVBoxLayout(self.view_tab)
        view_layout.setContentsMargins(0, 10, 0, 0)
        
        self.code_view = QTextEdit()
        self.code_view.setReadOnly(True)
        self.code_view.setStyleSheet("""
            QTextEdit {
                background-color: rgba(250, 250, 250, 0.7);
                border: 1px solid rgba(0, 0, 0, 0.1);
                border-radius: 8px;
                padding: 10px;
                font-family: "SF Mono", Monaco, monospace;
                font-size: 13px;
            }
        """)
        view_layout.addWidget(self.code_view)
        
        # –í–∫–ª–∞–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
        self.result_tab = QWidget()
        result_layout = QVBoxLayout(self.result_tab)
        result_layout.setContentsMargins(0, 10, 0, 0)
        
        # –ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç—É—Å–∞
        status_frame = QFrame()
        status_frame.setFrameStyle(QFrame.StyledPanel | QFrame.Raised)
        status_frame.setStyleSheet("""
            QFrame {
                background-color: rgba(250, 250, 250, 0.7);
                border: 1px solid rgba(0, 0, 0, 0.1);
                border-radius: 8px;
                margin-bottom: 10px;
            }
        """)
        status_layout = QVBoxLayout(status_frame)
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—É—Å–∞
        status_header = QLabel("–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å:")
        status_header.setStyleSheet("font-weight: bold; font-size: 14px; color: #333;")
        status_layout.addWidget(status_header)
        
        # –¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞
        self.status_label = QLabel("–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞–ø—É—Å–∫—É...")
        self.status_label.setStyleSheet("padding: 10px; font-size: 13px; color: #666;")
        status_layout.addWidget(self.status_label)
        
        result_layout.addWidget(status_frame)
        
        # –õ–æ–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
        self.result_view = QTextEdit()
        self.result_view.setReadOnly(True)
        self.result_view.setStyleSheet("""
            QTextEdit {
                background-color: rgba(250, 250, 250, 0.7);
                border: 1px solid rgba(0, 0, 0, 0.1);
                border-radius: 8px;
                padding: 10px;
                font-family: "SF Pro", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
                font-size: 13px;
            }
        """)
        result_layout.addWidget(self.result_view)
        
        self.tabs.addTab(self.view_tab, "–ü—Ä–æ–≥—Ä–∞–º–∞")
        self.tabs.addTab(self.result_tab, "–†–µ–∑—É–ª—å—Ç–∞—Ç–∏")
        
        main_content_layout.addWidget(self.tabs)
        content_layout.addWidget(main_content)
        
        # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ä–æ–∑–º—ñ—Ä–∏ –±—ñ—á–Ω–æ—ó –ø–∞–Ω–µ–ª—ñ —Ç–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É
        content_layout.setStretch(0, 1)  # –ë—ñ—á–Ω–∞ –ø–∞–Ω–µ–ª—å
        content_layout.setStretch(1, 3)  # –û—Å–Ω–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
        
        container_layout.addWidget(content_container)
        
        # –î–æ–¥–∞—î–º–æ –æ—Å–Ω–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–æ –º–∞–∫–µ—Ç—É
        main_layout.addWidget(main_container)
        
        # –°—Ç–∞—Ç—É—Å –±–∞—Ä
        self.statusBar().showMessage("–ì–æ—Ç–æ–≤–∏–π –¥–æ —Ä–æ–±–æ—Ç–∏")
        self.statusBar().setStyleSheet("""
            QStatusBar {
                background-color: rgba(240, 240, 240, 0.9);
                border-top: 1px solid rgba(0, 0, 0, 0.1);
                border-bottom-left-radius: 15px;
                border-bottom-right-radius: 15px;
                padding-left: 10px;
            }
        """)
        
        # –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –ø—Ä–æ–≥—Ä–∞–º
        self.load_program_list()
    
    def load_program_list(self):
        """–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –ø—Ä–æ–≥—Ä–∞–º"""
        self.program_list.clear()
        for program in self.programs:
            self.program_list.addItem(program.get("name", "–ë–µ–∑ –Ω–∞–∑–≤–∏"))
    
    def on_program_selected(self, index):
        """–û–±—Ä–æ–±–∫–∞ –≤–∏–±–æ—Ä—É –ø—Ä–æ–≥—Ä–∞–º–∏ –≤ —Å–ø–∏—Å–∫—É"""
        if index >= 0 and index < len(self.programs):
            program = self.programs[index]
            self.current_program = program
            self.code_view.setPlainText(program.get("code", ""))
            self.result_view.clear()
            self.status_label.setText("–û–±—Ä–∞–Ω–æ –ø—Ä–æ–≥—Ä–∞–º—É...")
            self.status_label.setStyleSheet("padding: 10px; color: black;")
        else:
            self.current_program = None
            self.code_view.clear()
            self.result_view.clear()
    
    def create_program(self):
        """–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ—ó –ø—Ä–æ–≥—Ä–∞–º–∏"""
        dialog = ProgramEditorDialog(parent=self)
        if dialog.exec_():
            program_data = dialog.get_program_data()
            if not program_data["name"]:
                QMessageBox.warning(self, "–ü–æ–º–∏–ª–∫–∞", "–ù–∞–∑–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–∏ –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—å–æ—é")
                return
            
            self.programs.append(program_data)
            self.save_config()
            self.load_program_list()
            self.status_label.setText("–°—Ç–≤–æ—Ä–µ–Ω–æ –Ω–æ–≤—É –ø—Ä–æ–≥—Ä–∞–º—É...")
            self.status_label.setStyleSheet("padding: 10px; color: black;")
    
    def edit_program(self):
        """–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –æ–±—Ä–∞–Ω–æ—ó –ø—Ä–æ–≥—Ä–∞–º–∏"""
        if not self.current_program:
            QMessageBox.warning(self, "–ü–æ–º–∏–ª–∫–∞", "–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –ø—Ä–æ–≥—Ä–∞–º—É –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è")
            return
        
        index = self.program_list.currentRow()
        dialog = ProgramEditorDialog(
            program_name=self.current_program.get("name", ""),
            program_code=self.current_program.get("code", ""),
            parent=self
        )
        
        if dialog.exec_():
            program_data = dialog.get_program_data()
            if not program_data["name"]:
                QMessageBox.warning(self, "–ü–æ–º–∏–ª–∫–∞", "–ù–∞–∑–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–∏ –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—å–æ—é")
                return
            
            self.programs[index] = program_data
            self.save_config()
            self.load_program_list()
            self.program_list.setCurrentRow(index)
            self.status_label.setText("–ü—Ä–æ–≥—Ä–∞–º—É –æ–Ω–æ–≤–ª–µ–Ω–æ...")
            self.status_label.setStyleSheet("padding: 10px; color: black;")
    
    def delete_program(self):
        """–í–∏–¥–∞–ª–µ–Ω–Ω—è –æ–±—Ä–∞–Ω–æ—ó –ø—Ä–æ–≥—Ä–∞–º–∏"""
        if not self.current_program:
            QMessageBox.warning(self, "–ü–æ–º–∏–ª–∫–∞", "–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –ø—Ä–æ–≥—Ä–∞–º—É –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è")
            return
        
        index = self.program_list.currentRow()
        program_name = self.current_program.get("name", "–ë–µ–∑ –Ω–∞–∑–≤–∏")
        
        reply = QMessageBox.question(
            self, "–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è", 
            f"–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –ø—Ä–æ–≥—Ä–∞–º—É '{program_name}'?",
            QMessageBox.Yes | QMessageBox.No
        )
        
        if reply == QMessageBox.Yes:
            self.programs.pop(index)
            self.save_config()
            self.load_program_list()
            self.status_label.setText("–ü—Ä–æ–≥—Ä–∞–º—É –≤–∏–¥–∞–ª–µ–Ω–æ...")
            self.status_label.setStyleSheet("padding: 10px; color: black;")
    
    def run_program(self):
        """–ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–Ω–æ—ó –ø—Ä–æ–≥—Ä–∞–º–∏"""
        if not self.current_program:
            QMessageBox.warning(self, "–ü–æ–º–∏–ª–∫–∞", "–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –ø—Ä–æ–≥—Ä–∞–º—É –¥–ª—è –∑–∞–ø—É—Å–∫—É")
            return
            
        if not self.check_api_key():
            return
            
        program_code = self.current_program.get("code", "")
        if not program_code:
            QMessageBox.warning(self, "–ü–æ–º–∏–ª–∫–∞", "–ü—Ä–æ–≥—Ä–∞–º–∞ –ø–æ—Ä–æ–∂–Ω—è")
            return
            
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞ –≤–∂–µ –ø—Ä–æ–≥—Ä–∞–º–∞
        if self.program_running:
            QMessageBox.warning(self, "–ü–æ–º–∏–ª–∫–∞", "–ü—Ä–æ–≥—Ä–∞–º–∞ –≤–∂–µ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è")
            return
            
        # –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
        self.program_running = True
        self.pause_button.setEnabled(True)
        self.stop_button.setEnabled(True)
        self.run_button.setEnabled(False)
        
        # –û—á–∏—â–∞—î–º–æ –≤—ñ–∫–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
        self.result_view.clear()
        
        # –í–∏–∑–Ω–∞—á–∞—î–º–æ —Ä–µ–∂–∏–º –∑–∞–ø—É—Å–∫—É
        headless = self.headless_checkbox.isChecked()
        use_user_profile = self.use_user_profile_checkbox.isChecked()
        user_profile = self.chrome_profile_path if use_user_profile else None
        
        # –°—Ç–≤–æ—Ä—é—î–º–æ —ñ –∑–∞–ø—É—Å–∫–∞—î–º–æ runner
        self.browser_runner = BrowserUseRunner(
            api_key=self.api_key,
            task=program_code,
            headless=headless,
            user_profile_dir=user_profile
        )
        
        # –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ —Å–∏–≥–Ω–∞–ª–∏
        self.browser_runner.log_signal.connect(self.on_browser_log)
        self.browser_runner.error_signal.connect(self.on_browser_error)
        self.browser_runner.finished_signal.connect(self.on_browser_finished)
        
        # –ó–∞–ø—É—Å–∫–∞—î–º–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
        self.browser_runner.start()
        
        self.status_label.setText("–ó–∞–ø—É—â–µ–Ω–æ –ø—Ä–æ–≥—Ä–∞–º—É...")
        self.status_label.setStyleSheet("padding: 10px; color: black;")
    
    def on_browser_log(self, message):
        """–û–±—Ä–æ–±–Ω–∏–∫ –ª–æ–≥—ñ–≤ –≤—ñ–¥ browser-use"""
        # –î–æ–¥–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ –ª–æ–≥ –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–º —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è–º
        if "üéØ –ù–∞—Å—Ç—É–ø–Ω–∞ —Ü—ñ–ª—å:" in message:
            self.result_view.append(f"<span style='color: #2196F3;'>{message}</span>")
        elif "‚úì –†–µ–∑—É–ª—å—Ç–∞—Ç:" in message:
            self.result_view.append(f"<span style='color: #4CAF50;'>{message}</span>")
        elif "ü§î –ú–æ–¥–µ–ª—å –¥—É–º–∞—î:" in message:
            self.result_view.append(f"<span style='color: #FF9800;'>{message}</span>")
        elif "üåê –ë—Ä–∞—É–∑–µ—Ä:" in message:
            self.result_view.append(f"<span style='color: #9C27B0;'>{message}</span>")
        elif "‚ùå –ü–æ–º–∏–ª–∫–∞:" in message:
            self.result_view.append(f"<span style='color: #F44336;'>{message}</span>")
        else:
            self.result_view.append(message)
        
        # –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å —É –≤–µ—Ä—Ö–Ω—å–æ–º—É –ø–æ–ª—ñ
        self.status_label.setText(message)
        if "üéØ –ù–∞—Å—Ç—É–ø–Ω–∞ —Ü—ñ–ª—å:" in message:
            self.status_label.setStyleSheet("padding: 10px; color: #2196F3;")
        elif "‚úì –†–µ–∑—É–ª—å—Ç–∞—Ç:" in message:
            self.status_label.setStyleSheet("padding: 10px; color: #4CAF50;")
        elif "ü§î –ú–æ–¥–µ–ª—å –¥—É–º–∞—î:" in message:
            self.status_label.setStyleSheet("padding: 10px; color: #FF9800;")
        elif "üåê –ë—Ä–∞—É–∑–µ—Ä:" in message:
            self.status_label.setStyleSheet("padding: 10px; color: #9C27B0;")
        elif "‚ùå –ü–æ–º–∏–ª–∫–∞:" in message:
            self.status_label.setStyleSheet("padding: 10px; color: #F44336;")
        else:
            self.status_label.setStyleSheet("padding: 10px; color: black;")
        
        # –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–æ –Ω–∏–∂–Ω—å–æ–≥–æ –∫—Ä–∞—é
        self.result_view.verticalScrollBar().setValue(
            self.result_view.verticalScrollBar().maximum()
        )
    
    def on_browser_error(self, error_message):
        """–û–±—Ä–æ–±–Ω–∏–∫ –ø–æ–º–∏–ª–æ–∫ –≤—ñ–¥ browser-use"""
        self.result_view.append(f"<span style='color: red;'>{error_message}</span>")
        # –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
        self.program_running = False
        self.pause_button.setEnabled(False)
        self.stop_button.setEnabled(False)
        self.run_button.setEnabled(True)
    
    def on_browser_finished(self):
        """–û–±—Ä–æ–±–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è browser-use"""
        self.result_view.append("–í–∏–∫–æ–Ω–∞–Ω–Ω—è –ø—Ä–æ–≥—Ä–∞–º–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.")
        # –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
        self.program_running = False
        self.pause_button.setEnabled(False)
        self.stop_button.setEnabled(False)
        self.run_button.setEnabled(True)
    
    def pause_program(self):
        """–ü—Ä–∏–∑—É–ø–∏–Ω–µ–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø—Ä–æ–≥—Ä–∞–º–∏"""
        if not self.program_running or not self.browser_runner:
            return
            
        if self.browser_runner._is_paused:
            # –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
            self.browser_runner.resume()
            self.pause_button.setText("–ü–∞—É–∑–∞")
        else:
            # –ü—Ä–∏–∑—É–ø–∏–Ω–µ–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
            self.browser_runner.pause()
            self.pause_button.setText("–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏")
        
        self.status_label.setText("–ü—Ä–æ–≥—Ä–∞–º—É –ø—Ä–∏–∑—É–ø–∏–Ω–µ–Ω–æ/–≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ...")
        self.status_label.setStyleSheet("padding: 10px; color: black;")
    
    def stop_program(self):
        """–ó—É–ø–∏–Ω–∫–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø—Ä–æ–≥—Ä–∞–º–∏"""
        if not self.program_running or not self.browser_runner:
            return
            
        # –ó—É–ø–∏–Ω—è—î–º–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
        self.browser_runner.stop()
        
        # –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
        self.program_running = False
        self.pause_button.setEnabled(False)
        self.stop_button.setEnabled(False)
        self.run_button.setEnabled(True)
        self.pause_button.setText("–ü–∞—É–∑–∞")
        
        self.status_label.setText("–ü—Ä–æ–≥—Ä–∞–º—É –∑—É–ø–∏–Ω–µ–Ω–æ...")
        self.status_label.setStyleSheet("padding: 10px; color: black;")
    
    def change_api_key(self):
        """–ó–º—ñ–Ω–∞ API –∫–ª—é—á–∞"""
        dialog = ApiKeyDialog(self)
        dialog.key_input.setText("")  # –ü–æ–ª–µ –≤–≤–æ–¥–∞ –≤—Å–µ–≥–¥–∞ –ø—É—Å—Ç–æ–µ, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –∫–ª—é—á–∞
        
        if dialog.exec_():
            self.api_key = dialog.api_key
            self.save_config()
            self.status_label.setText("API –∫–ª—é—á –æ–Ω–æ–≤–ª–µ–Ω–æ")

    def closeEvent(self, event):
        """–û–±—Ä–æ–±–∫–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è –¥–æ–¥–∞—Ç–∫—É"""
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –ø—Ä–æ–≥—Ä–∞–º–∞
        if self.program_running:
            reply = QMessageBox.question(
                self, "–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è", 
                "–ü—Ä–æ–≥—Ä–∞–º–∞ –≤—Å–µ —â–µ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è. –í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–π—Ç–∏?",
                QMessageBox.Yes | QMessageBox.No
            )
            
            if reply == QMessageBox.Yes:
                self.stop_program()
                event.accept()
            else:
                event.ignore()
                return
                
        # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –ø–µ—Ä–µ–¥ –≤–∏—Ö–æ–¥–æ–º
        self.save_config()
        event.accept()

if __name__ == "__main__":
    app = QApplication(sys.argv)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ API –∫–ª—é—á–∞
    if len(sys.argv) > 1 and sys.argv[1] == "--reset-api-key":
        # –ï—Å–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —É–¥–∞–ª—è–µ–º API –∫–ª—é—á
        if os.path.exists(CONFIG_FILE):
            try:
                with open(CONFIG_FILE, 'r') as f:
                    config = json.load(f)
                    # –£–¥–∞–ª—è–µ–º –∫–ª—é—á API, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–æ–≥—Ä–∞–º–º—ã
                    config['api_key'] = ""
                with open(CONFIG_FILE, 'w') as f:
                    json.dump(config, f)
                print("API –∫–ª—é—á —Å–±—Ä–æ—à–µ–Ω!")
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ API –∫–ª—é—á–∞: {e}")
    
    window = WebMorpherApp()
    window.show()
    sys.exit(app.exec_()) 